<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CodePlay Editor</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíª</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['sans-serif'], mono: ['Menlo', 'Monaco', 'Consolas', 'monospace'] },
            colors: { editor: { bg: '#1e1e1e', sidebar: '#252526', active: '#37373d', border: '#333' } }
          },
        },
      }
    </script>
    
    <!-- React & Babel & JSZip -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1e1e1e; }
      ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
      body { margin: 0; overflow: hidden; background-color: #111827; touch-action: manipulation; }
      #root { height: 100vh; height: 100dvh; }
      input, textarea, button { font-size: 14px; }
      textarea::placeholder { color: #555; opacity: 1; }
      .folder-content { transition: all 0.2s; overflow: hidden; }
    </style>
  </head>
  <body>
    <div id="root" class="w-screen flex flex-col"></div>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- „Ç¢„Ç§„Ç≥„É≥ ---
      const Icon = ({ path, size = 18, className = "", style={} }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style} dangerouslySetInnerHTML={{ __html: path }} />
      );
      const Icons = {
        Menu: (p) => <Icon {...p} path='<line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="18" y2="18"/>' />,
        Plus: (p) => <Icon {...p} path='<path d="M5 12h14"/><path d="M12 5v14"/>' />,
        NewFolder: (p) => <Icon {...p} path='<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="11" y2="17"/><line x1="9" x2="15" y1="14" y2="14"/>' />,
        Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>' />,
        Folder: (p) => <Icon {...p} path='<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>' />,
        Edit: (p) => <Icon {...p} path='<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/>' />,
        File: (p) => <Icon {...p} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/>' />,
        X: (p) => <Icon {...p} path='<path d="M18 6 6 18"/><path d="m6 6 12 12"/>' />,
        Code: (p) => <Icon {...p} path='<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>' />,
        Play: (p) => <Icon {...p} path='<polygon points="5 3 19 12 5 21 5 3"/>' />,
        List: (p) => <Icon {...p} path='<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>' />,
        RotateCcw: (p) => <Icon {...p} path='<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>' />,
        SelectAll: (p) => <Icon {...p} path='<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>' />,
        Download: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>' />,
        Upload: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>' />,
        Archive: (p) => <Icon {...p} path='<rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/>' />,
        ChevronRight: (p) => <Icon {...p} path='<polyline points="9 18 15 12 9 6"/>' />,
        ChevronDown: (p) => <Icon {...p} path='<polyline points="6 9 12 15 18 9"/>' />
      };

      const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

      const Editor = ({ file, onChange }) => {
        const textareaRef = useRef(null);
        useEffect(() => { if (textareaRef.current) textareaRef.current.scrollTop = 0; }, [file?.id]);

        const handleKeyDown = (e) => {
          if (e.key === 'Tab') {
            e.preventDefault();
            const start = e.target.selectionStart;
            const end = e.target.selectionEnd;
            const val = file?.content || '';
            onChange(val.substring(0, start) + '  ' + val.substring(end));
            requestAnimationFrame(() => { e.target.selectionStart = e.target.selectionEnd = start + 2; });
          }
        };

        const handleSelectAll = () => { if (textareaRef.current) { textareaRef.current.focus(); textareaRef.current.select(); } };

        if (!file) return <div className="flex-1 flex flex-col items-center justify-center text-gray-500 bg-editor-bg h-full"><Icons.Code size={48} className="mb-4 opacity-20" /><p>„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div>;

        return (
          <div className="flex flex-col h-full bg-editor-bg relative group">
            <div className="flex items-center justify-between px-4 py-2 bg-editor-sidebar border-b border-editor-border shrink-0">
              <span className="text-sm font-medium text-gray-200">{file.name}</span>
              <button onClick={handleSelectAll} className="flex flex-col items-center justify-center p-1 text-gray-500 hover:text-white rounded hover:bg-gray-700 w-12 transition-colors">
                <Icons.SelectAll size={18} />
                <span className="text-[10px] mt-0.5">ÂÖ®ÈÅ∏Êäû</span>
              </button>
            </div>
            <textarea
              ref={textareaRef}
              value={file.content}
              onChange={(e) => onChange(e.target.value)}
              onKeyDown={handleKeyDown}
              className="flex-1 w-full bg-editor-bg text-gray-300 font-mono text-sm p-4 resize-none focus:outline-none leading-6"
              spellCheck={false}
              autoCapitalize="off"
              placeholder="„Åì„Åì„Å´„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            />
          </div>
        );
      };

      // --- „ÉÑ„É™„ÉºÊßãÁØâ„É≠„Ç∏„ÉÉ„ÇØ ---
      const buildFileTree = (files) => {
        const root = { name: "root", isFolder: true, children: {}, path: "" };
        files.forEach(file => {
          const parts = file.name.split('/');
          let current = root;
          parts.forEach((part, index) => {
            const currentPath = parts.slice(0, index + 1).join('/');
            if (index === parts.length - 1) {
              // „Éï„Ç°„Ç§„É´
              current.children[part] = { ...file, isFolder: false, path: file.name };
            } else {
              // „Éï„Ç©„É´„ÉÄ
              if (!current.children[part]) {
                current.children[part] = { name: part, isFolder: true, children: {}, path: currentPath };
              }
              current = current.children[part];
            }
          });
        });
        return root;
      };

      // --- ÂÜçÂ∏∞ÁöÑ„Éï„Ç©„É´„ÉÄ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà („É™„Éç„Éº„É†„ÉªÂâäÈô§Ê©üËÉΩËøΩÂä†) ---
      const FileTreeNode = ({ node, activeFileId, onSelect, onDelete, onRenameFile, onRenameFolder, onDeleteFolder, depth = 0 }) => {
        const [isOpen, setIsOpen] = useState(true);

        // „Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
        if (!node.isFolder) {
          return (
             <div onClick={() => onSelect(node.id)} className={`group flex justify-between items-center py-1.5 pr-2 cursor-pointer text-sm hover:bg-gray-800 ${activeFileId === node.id ? 'bg-editor-active text-white border-l-2 border-l-blue-500' : 'text-gray-400 border-l-2 border-transparent'}`} style={{ paddingLeft: `${depth * 12 + 12}px` }}>
                <div className="flex items-center gap-1.5 min-w-0 overflow-hidden">
                   <Icons.File size={14} className="shrink-0 opacity-70" />
                   <span className="truncate">{node.name.split('/').pop()}</span>
                </div>
                <div className="flex opacity-0 group-hover:opacity-100 transition-opacity gap-1">
                   <button onClick={(e)=>{e.stopPropagation(); onRenameFile(node);}} className="text-gray-500 hover:text-white"><Icons.Edit size={13}/></button>
                   <button onClick={(e)=>{e.stopPropagation(); if(confirm(`${node.name} „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) onDelete(node.id);}} className="text-gray-500 hover:text-red-400"><Icons.Trash2 size={13}/></button>
                </div>
             </div>
          );
        }

        // „Éï„Ç©„É´„ÉÄ„ÅÆÂ†¥Âêà
        const children = Object.values(node.children).sort((a, b) => {
            if (a.isFolder === b.isFolder) return a.name.localeCompare(b.name);
            return a.isFolder ? -1 : 1;
        });

        if (node.name === "root") {
             return <div className="flex flex-col">{children.map((child) => <FileTreeNode key={child.path} node={child} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} depth={0} />)}</div>;
        }

        return (
          <div className="flex flex-col select-none">
            <div onClick={() => setIsOpen(!isOpen)} className={`group flex justify-between items-center py-1.5 pr-2 cursor-pointer text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors`} style={{ paddingLeft: `${depth * 12 + 6}px` }}>
              <div className="flex items-center gap-1 min-w-0 overflow-hidden">
                  <span className="p-0.5 text-gray-500">{isOpen ? <Icons.ChevronDown size={14}/> : <Icons.ChevronRight size={14}/>}</span>
                  <Icons.Folder size={14} className="shrink-0 text-blue-400" />
                  <span className="truncate font-medium">{node.name}</span>
              </div>
              <div className="flex opacity-0 group-hover:opacity-100 transition-opacity gap-1">
                  <button onClick={(e)=>{e.stopPropagation(); onRenameFolder(node.path, node.name);}} className="text-gray-500 hover:text-white"><Icons.Edit size={13}/></button>
                  <button onClick={(e)=>{e.stopPropagation(); if(confirm(`„Éï„Ç©„É´„ÉÄ ${node.name} „Å®‰∏≠Ë∫´„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) onDeleteFolder(node.path);}} className="text-gray-500 hover:text-red-400"><Icons.Trash2 size={13}/></button>
              </div>
            </div>
            {isOpen && (
              <div className="flex flex-col">
                {children.map((child) => (
                  <FileTreeNode key={child.path} node={child} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} depth={depth + 1} />
                ))}
              </div>
            )}
          </div>
        );
      };

      const FileExplorer = ({ files, activeFileId, onSelect, onAdd, onDelete, onUpload, onRenameFile, onRenameFolder, onDeleteFolder }) => {
        const [name, setName] = useState('');
        const [isAdding, setIsAdding] = useState(false);
        const fileInputRef = useRef(null);
        
        const fileTree = useMemo(() => buildFileTree(files), [files]);

        const handleSubmit = (e) => {
          e.preventDefault();
          if(!name) return;
          let lang = 'javascript';
          if(name.endsWith('.html')) lang = 'html';
          if(name.endsWith('.css')) lang = 'css';
          if(name.endsWith('.ts') || name.endsWith('.tsx')) lang = 'typescript';
          
          onAdd(name, lang, '');
          setName(''); setIsAdding(false);
        };

        const handleCreateFolder = () => {
          const folderName = prompt("Êñ∞Ë¶è„Éï„Ç©„É´„ÉÄÂêç:");
          if (folderName) {
            // Á©∫„Éï„Ç©„É´„ÉÄ„ÇíÁ∂≠ÊåÅ„Åô„Çã„Åü„ÇÅ„Å´.keep„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
            onAdd(`${folderName}/.keep`, 'text', '');
          }
        };

        const handleDownloadZip = async () => {
          if (!window.JSZip) { alert('JSZip library not loaded.'); return; }
          const zip = new JSZip();
          files.forEach(f => {
              if(!f.name.endsWith('.keep')) zip.file(f.name, f.content);
          });
          const content = await zip.generateAsync({type: "blob"});
          const link = document.createElement('a');
          link.href = URL.createObjectURL(content);
          link.download = `project_${new Date().getTime()}.zip`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const handleUpload = (e) => {
             const uploadedFiles = Array.from(e.target.files);
             uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    let lang = 'javascript'; 
                    if(file.name.endsWith('.html')) lang = 'html';
                    else if(file.name.endsWith('.css')) lang = 'css';
                    else if(file.name.endsWith('.ts') || file.name.endsWith('.tsx')) lang = 'typescript';
                    onUpload(file.name, ev.target.result, lang);
                };
                reader.readAsText(file);
             });
             e.target.value = '';
        }

        return (
          <div className="flex flex-col h-full bg-editor-sidebar border-r border-editor-border">
             <div className="p-3 border-b border-editor-border flex justify-between items-center shrink-0">
               <span className="text-xs font-bold text-gray-400">„Éï„Ç°„Ç§„É´‰∏ÄË¶ß</span>
               <div className="flex gap-1">
                 <button onClick={handleDownloadZip} className="text-gray-400 hover:text-white p-1" title="ZIP‰øùÂ≠ò"><Icons.Archive size={16}/></button>
                 <button onClick={()=>fileInputRef.current.click()} className="text-gray-400 hover:text-white p-1" title="Ë™≠Ëæº"><Icons.Upload size={16}/></button>
                 <button onClick={handleCreateFolder} className="text-gray-400 hover:text-white p-1" title="„Éï„Ç©„É´„ÉÄ‰ΩúÊàê"><Icons.NewFolder size={16}/></button>
                 <button onClick={()=>setIsAdding(!isAdding)} className="text-gray-400 hover:text-white p-1" title="„Éï„Ç°„Ç§„É´ËøΩÂä†"><Icons.Plus size={16}/></button>
               </div>
               <input type="file" multiple ref={fileInputRef} onChange={handleUpload} className="hidden" />
             </div>
             {isAdding && (
               <form onSubmit={handleSubmit} className="p-2 bg-gray-800 shrink-0 border-b border-editor-border">
                 <input value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-900 text-white text-sm p-2 rounded outline-none border border-blue-500" placeholder="‰æã: components/Btn.tsx" autoFocus onBlur={()=>{if(!name)setIsAdding(false)}}/>
               </form>
             )}
             <div className="flex-1 overflow-y-auto group">
               {files.length === 0 ? (
                 <div className="p-4 text-xs text-center text-gray-600">„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
               ) : (
                 <FileTreeNode node={fileTree} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} />
               )}
             </div>
          </div>
        );
      };

      const Preview = ({ files }) => {
        const [srcDoc, setSrcDoc] = useState('');

        useEffect(() => {
          const process = async () => {
            const fileMap = {};
            files.forEach(f => fileMap[f.name] = f.content);

            let originalHtml = fileMap['index.html'] || `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"></head><body><div id="root"></div></body></html>`;

            const css = files.filter(f => f.name.endsWith('.css')).map(f => f.content).join('\n');
            const styleTag = `<style>${css} body { background-color: white; }</style>`;
            if (originalHtml.includes('</head>')) originalHtml = originalHtml.replace('</head>', `${styleTag}</head>`);
            else originalHtml += styleTag;

            const imports = {
              "react": "https://esm.sh/react@18.2.0",
              "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
              "react-dom": "https://esm.sh/react-dom@18.2.0",
            };

            const scriptFiles = files.filter(f => /\.(ts|tsx|js|jsx)$/.test(f.name));
            
            for (const file of scriptFiles) {
              try {
                let code = file.content;
                const result = window.Babel.transform(code, {
                  presets: [['env', { modules: false, targets: { esmodules: true } }], 'react', 'typescript'],
                  filename: file.name
                });
                const blob = new Blob([result.code], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                const fullPath = "./" + file.name;
                const noExt = fullPath.replace(/\.(tsx|ts|jsx|js)$/, '');
                imports[fullPath] = url;
                imports[noExt] = url;
              } catch (e) { console.error("Compilation error:", file.name, e); }
            }

            const entryFile = files.find(f => 
              ['main.tsx', 'index.tsx', 'App.tsx', 'index.js', 'main.js'].includes(f.name) ||
              ['src/main.tsx', 'src/index.tsx', 'src/App.tsx'].includes(f.name)
            );

            const importMapScript = `<script type="importmap">${JSON.stringify({ imports }, null, 2)}<\/script>`;
            const tailwindScript = `<script src="https://cdn.tailwindcss.com"><\/script>`;
            const babelLib = `<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>`;
            
            let entryScript = '';
            if (entryFile) {
               entryScript = `<script type="module">import "${'./' + entryFile.name}";<\/script>`;
            }

            const headExtras = `${tailwindScript}${importMapScript}${babelLib}<script>tailwind.config={theme:{extend:{fontFamily:{sans:['sans-serif'],mono:['monospace']},colors:{editor:{bg:'#1e1e1e',sidebar:'#252526',active:'#37373d',border:'#333'}}}}};<\/script>`;

            let finalHtml = originalHtml;
            if (finalHtml.includes('<head>')) finalHtml = finalHtml.replace('<head>', `<head>${headExtras}`);
            else finalHtml = headExtras + finalHtml;

            if (finalHtml.includes('</body>')) finalHtml = finalHtml.replace('</body>', `${entryScript}</body>`);
            else finalHtml += entryScript;

            setSrcDoc(finalHtml);
          };
          process();
        }, [files]);

        return <iframe srcDoc={srcDoc} className="flex-1 w-full h-full bg-white border-none" sandbox="allow-scripts allow-modals allow-same-origin allow-forms" title="Preview" />;
      };

      const Sidebar = ({ isOpen, onClose, projects, onSave, onLoad, onDelete, onClear, onImportJSON }) => {
        const fileInputRef = useRef(null);
        const handleExportJSON = () => {
          const blob = new Blob([JSON.stringify(projects, null, 2)], { type: "application/json" });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `codeplay_backup_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const handleFileChange = (e) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try { onImportJSON(JSON.parse(event.target.result)); alert("Âæ©ÂÖÉ„Åó„Åæ„Åó„ÅüÔºÅ"); } catch { alert("„Ç®„É©„Éº"); }
          };
          reader.readAsText(e.target.files[0]); e.target.value = '';
        };

        if(!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex">
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="relative w-80 max-w-[85%] bg-gray-900 border-r border-gray-700 flex flex-col h-full shadow-2xl animate-in slide-in-from-left duration-200">
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center h-16">
                        <span className="text-white font-bold flex gap-2 items-center"><Icons.Folder size={20} className="text-blue-500"/> „Éó„É≠„Ç∏„Çß„ÇØ„Éà</span>
                        <button onClick={onClose}><Icons.X size={20} className="text-gray-400"/></button>
                    </div>
                    <div className="p-4 space-y-3 border-b border-gray-800">
                         <button onClick={()=>{const n=prompt('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç:'); if(n) onSave(n)}} className="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold hover:bg-blue-500">‰øùÂ≠ò„Åô„Çã</button>
                         <div className="flex gap-2">
                            <button onClick={handleExportJSON} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded text-xs flex items-center justify-center gap-1 border border-gray-700"><Icons.Download size={14}/> „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
                            <button onClick={()=>fileInputRef.current.click()} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded text-xs flex items-center justify-center gap-1 border border-gray-700"><Icons.Upload size={14}/> Âæ©ÂÖÉ</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
                         </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                        {projects.length===0 && <div className="text-center text-gray-500 text-xs mt-10">„Å™„Åó</div>}
                        {projects.map(p => (
                            <div key={p.id} className="bg-gray-800 p-3 rounded flex justify-between items-center group">
                                <div onClick={()=>{if(confirm('Ë™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü')){onLoad(p);onClose()}}} className="flex-1 cursor-pointer">
                                    <div className="text-sm font-bold text-gray-200">{p.name}</div>
                                    <div className="text-xs text-gray-500">{new Date(p.createdAt).toLocaleDateString()}</div>
                                </div>
                                <button onClick={()=>onDelete(p.id)} className="text-gray-500 hover:text-red-400 p-2"><Icons.Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 border-t border-gray-800"><button onClick={onClear} className="w-full text-red-500 text-xs py-2 border border-red-900/30 rounded">ÂÖ®Ê∂àÂéª</button></div>
                </div>
            </div>
        );
      };

      const App = () => {
        const INITIAL_FILES = [];

        const [files, setFiles] = useState(INITIAL_FILES);
        const [activeId, setActiveId] = useState(null);
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [mobileTab, setMobileTab] = useState('files');
        const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

        const [projects, setProjects] = useState(() => { try { return JSON.parse(localStorage.getItem('cp_projects')||'[]'); } catch{ return []; } });
        useEffect(() => localStorage.setItem('cp_projects', JSON.stringify(projects)), [projects]);
        useEffect(() => {
            const handleResize = () => setIsMobile(window.innerWidth < 768);
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        // --- „Éï„Ç°„Ç§„É´Êìç‰Ωú„É≠„Ç∏„ÉÉ„ÇØ ---
        const handleRenameFile = (node) => {
            const newName = prompt("Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´Âêç („Éë„Çπ„ÇíÂê´„ÇÅ„Çã„Å®ÁßªÂãï„Åó„Åæ„Åô):", node.name);
            if (newName && newName !== node.name) {
                setFiles(prev => prev.map(f => f.id === node.id ? { ...f, name: newName } : f));
            }
        };

        const handleRenameFolder = (oldPath, oldName) => {
            const newName = prompt("Êñ∞„Åó„ÅÑ„Éï„Ç©„É´„ÉÄÂêç:", oldName);
            if (newName && newName !== oldName) {
                // oldPath (‰æã: "components") „Çí„Éë„Çπ„Å´Âê´„ÇÄÂÖ®„Éï„Ç°„Ç§„É´„ÇíÁΩÆÊèõ
                const prefix = oldPath + "/";
                const parentPath = oldPath.substring(0, oldPath.lastIndexOf('/'));
                const newPath = parentPath ? `${parentPath}/${newName}` : newName;
                
                setFiles(prev => prev.map(f => {
                    if (f.name.startsWith(prefix)) {
                        return { ...f, name: f.name.replace(oldPath, newPath) };
                    }
                    return f;
                }));
            }
        };

        const handleDeleteFolder = (path) => {
            setFiles(prev => prev.filter(f => !f.name.startsWith(path + "/")));
        };

        const activeFile = files.find(f => f.id === activeId);

        return (
          <div className="flex flex-col h-full text-white font-sans bg-gray-900">
            <header className="bg-editor-sidebar border-b border-editor-border p-1 flex items-center justify-between shrink-0 h-16 z-20 shadow-md">
               <div className="flex items-center gap-2 pl-1">
                 <button onClick={()=>setSidebarOpen(true)} className="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-white rounded hover:bg-gray-700 w-14">
                   <Icons.Menu size={20}/> <span className="text-[10px] mt-0.5">„É°„Éã„É•„Éº</span>
                 </button>
                 <div className="flex flex-col justify-center">
                   <span className="font-bold text-base tracking-tight leading-tight">CodePlay</span>
                   <span className="text-[10px] text-gray-500 leading-tight">Editor</span>
                 </div>
               </div>
               <div className="flex items-center gap-1 pr-1">
                 <button onClick={()=>{if(confirm('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')){setFiles(INITIAL_FILES); setActiveId(null);}}} className="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-white rounded hover:bg-gray-700 w-14">
                    <Icons.RotateCcw size={18}/> <span className="text-[10px] mt-0.5">„É™„Çª„ÉÉ„Éà</span>
                 </button>
               </div>
            </header>

            <main className="flex-1 flex overflow-hidden relative">
               <div className={`${(isMobile && mobileTab !== 'files') ? 'hidden' : 'flex'} w-full md:w-56 md:flex-none flex-col h-full z-10 border-r border-editor-border bg-editor-sidebar`}>
                  <FileExplorer 
                    files={files} 
                    activeFileId={activeId} 
                    onSelect={(id)=>{setActiveId(id); if(isMobile) setMobileTab('editor');}} 
                    onAdd={(n,l,c)=>setFiles([...files, {id:generateId(), name:n, language:l, content:c||''} ])} 
                    onDelete={(id)=>{setFiles(f=>f.filter(x=>x.id!==id)); if(activeId===id) setActiveId(null);}} 
                    onUpload={(n,c,l)=>setFiles(prev=>[...prev, {id:generateId(), name:n, language:l, content:c}])}
                    onRenameFile={handleRenameFile}
                    onRenameFolder={handleRenameFolder}
                    onDeleteFolder={handleDeleteFolder}
                  />
               </div>
               <div className={`${(isMobile && mobileTab !== 'editor') ? 'hidden' : 'flex'} flex-1 flex-col min-w-0 md:border-r border-editor-border md:max-w-[50%]`}>
                 <Editor file={activeFile} onChange={(val)=>setFiles(files.map(f=>f.id===activeId?{...f, content:val}:f))} />
               </div>
               <div className={`${(isMobile && mobileTab !== 'preview') ? 'hidden' : 'flex'} flex-1 flex-col bg-white h-full`}>
                  <Preview files={files} />
               </div>
            </main>

            <div className="md:hidden h-16 bg-editor-sidebar border-t border-editor-border flex items-center justify-around shrink-0 pb-safe z-30">
              <button onClick={()=>setMobileTab('files')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='files'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.List size={20}/> <span className="text-[10px]">„Éï„Ç°„Ç§„É´</span></button>
              <button onClick={()=>setMobileTab('editor')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='editor'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.Code size={20}/> <span className="text-[10px]">„Ç≥„Éº„Éâ</span></button>
              <button onClick={()=>setMobileTab('preview')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='preview'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.Play size={20}/> <span className="text-[10px]">„Éó„É¨„Éì„É•„Éº</span></button>
            </div>
            <Sidebar isOpen={sidebarOpen} onClose={()=>setSidebarOpen(false)} projects={projects} onSave={(n)=>setProjects(prev => [{id:generateId(), name:n, files:[...files], createdAt:Date.now()}, ...prev])} onLoad={(p)=>{setFiles(p.files); setActiveId(p.files[0]?.id)}} onDelete={(id)=>setProjects(p=>p.filter(x=>x.id!==id))} onClear={()=>{if(confirm('ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) setProjects([])}} onImportJSON={(json)=>setProjects(prev => [...json, ...prev])} />
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
